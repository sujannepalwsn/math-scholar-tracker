-- Update policy to allow center users to link parents to students within their center (FOR INSERT)
ALTER POLICY "Center users can link parents to students within their center"
ON public.parent_students
WITH CHECK (
    auth.role() = 'center'
    AND
    (SELECT center_id FROM public.users WHERE id = auth.uid()) IS NOT NULL
    AND
    (SELECT center_id FROM public.users WHERE id = auth.uid()) = (SELECT center_id FROM public.users WHERE id = parent_user_id)
    AND
    (SELECT center_id FROM public.users WHERE id = auth.uid()) = (SELECT center_id FROM public.students WHERE id = student_id)
);